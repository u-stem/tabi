# PWA + Offline Viewing Design

## Goal

Travel itinerary data and map tiles are cached via Service Worker so users can view their plans offline while traveling.

## Architecture

Use **Serwist** (next-pwa successor) with Next.js App Router for Service Worker generation and cache management.

### Caching Strategy

| Resource | Strategy | Details |
|----------|----------|---------|
| App Shell (HTML/JS/CSS) | Precache | Built at build time, loads instantly |
| API responses (`/api/trips/*`) | NetworkFirst | Latest data preferred, cache fallback offline |
| Map tiles (tile.openstreetmap.org) | CacheFirst | Tiles are immutable. Max 500 entries / 50MB / 30 days |
| Static assets (images/fonts) | CacheFirst | Low change frequency |

### Offline UI Behavior

- Offline detection via `navigator.onLine` + event listeners
- Header shows "offline" banner when disconnected
- Edit actions (add/delete/reorder) are disabled with tooltip
- Dashboard trip list renders from cache

### PWA Manifest

- `name`: "tabi - travel planner"
- `short_name`: "tabi"
- `start_url`: "/dashboard"
- `display`: "standalone"
- Icons: 192x192, 512x512 PNG

### Service Worker Lifecycle

- Auto-generated by Serwist at build time
- `skipWaiting` for immediate updates on new deploys
- Cache expiration via `ExpirationPlugin`:
  - Map tiles: 500 entries / 50MB / 30 days
  - API responses: 50 entries / 7 days

## Files

```
apps/web/
├── app/
│   ├── manifest.ts              # NEW: Web App Manifest
│   └── layout.tsx               # MODIFY: add manifest link
├── components/
│   ├── offline-banner.tsx       # NEW: offline state banner
│   └── header.tsx               # MODIFY: include OfflineBanner
├── lib/
│   ├── sw.ts                    # NEW: Service Worker runtime cache config
│   └── hooks/
│       └── use-online-status.ts # NEW: online/offline hook
├── public/
│   └── icons/                   # NEW: PWA icons (192, 512)
├── next.config.ts               # MODIFY: Serwist plugin
└── package.json                 # MODIFY: add @serwist/next
```

## Out of Scope

- Offline editing / sync
- Push notifications
- Background sync
- Custom install banner
- Pre-downloading map tiles (only cache viewed tiles)

## Testing

- `use-online-status` hook: vitest unit test
- Service Worker caching: manual via Chrome DevTools > Application
- Lighthouse PWA audit for score check
